# Uni
[Project page](https://scrapbox.io/motoso/Uni%EF%BC%9AScrapbox%E3%81%A7%E3%81%AE%E8%94%B5%E6%9B%B8%E7%AE%A1%E7%90%86%E3%82%92%E6%94%AF%E6%8F%B4%E3%81%99%E3%82%8BChrome%E6%8B%A1%E5%BC%B5)

## „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊ¶ÇË¶Å

Uni„ÅØ„ÄÅ„Åï„Åæ„Åñ„Åæ„Å™Êõ∏Á±ç„ÉªÂêå‰∫∫Ë™å„ÉªÂãïÁîª„Çµ„Ç§„Éà„Åã„ÇâÊÉÖÂ†±„ÇíÂèéÈõÜ„Åó„ÄÅCosense„ÅßËîµÊõ∏ÁÆ°ÁêÜ„Çí„Åô„Çã„Åü„ÇÅ„ÅÆWeb„Éñ„É©„Ç¶„Ç∂Êã°ÂºµÊ©üËÉΩ„Åß„Åô„ÄÇ**Chrome** „Å® **Firefox** „Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

### ÂØæÂøú„Çµ„Éº„Éì„Çπ

#### Êõ∏Á±ç„Çµ„Éº„Éì„Çπ
- FANZA
- DLsite
- Amazon
- Book Walker

#### Âêå‰∫∫Ë™å„Çµ„Éº„Éì„Çπ
- „Å®„Çâ„ÅÆ„ÅÇ„Å™
- „É°„É≠„É≥„Éñ„ÉÉ„ÇØ„Çπ
- ÈßøÊ≤≥Â±ã
- DLsiteManiax
- FANZAÔºàÂêå‰∫∫Ôºâ

#### ÂãïÁîª„Çµ„Éº„Éì„Çπ
- FANZAÔºàÂãïÁîªÔºâ
- FANZAÔºà„Ç¢„Éã„É°Ôºâ
- FC2„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Éû„Éº„Ç±„ÉÉ„Éà

### Ê©üËÉΩ

- ÂØæÂøú„Çµ„Ç§„Éà„ÅßÂïÜÂìÅ„Éö„Éº„Ç∏„ÇíÈñã„Åè„Å®„ÄÅËá™ÂãïÁöÑ„Å´„Åù„ÅÆÂïÜÂìÅÊÉÖÂ†±Ôºà„Çø„Ç§„Éà„É´„ÄÅËëóËÄÖ„Å™„Å©Ôºâ„ÇíÂèñÂæó
- Cosense„ÅÆÊåáÂÆö„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åß„ÄÅÂêå„ÅòÂïÜÂìÅ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÊ§úÁ¥¢
- Êó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åù„ÅÆ„Éö„Éº„Ç∏„Å∏„ÅÆ„É™„É≥„ÇØ„ÇíË°®Á§∫
- ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÊñ∞Ë¶è„Éö„Éº„Ç∏‰ΩúÊàêÁî®„ÅÆ„É™„É≥„ÇØ„ÇíË°®Á§∫

## ‰Ωø„ÅÑÊñπ

1. Êã°ÂºµÊ©üËÉΩ„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åã„ÇâCosense„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíË®≠ÂÆö„Åó„Åæ„Åô
2. ÂØæÂøú„Çµ„Éº„Éì„Çπ„ÅÆÂïÜÂìÅ„Éö„Éº„Ç∏„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Å®„ÄÅ„Éö„Éº„Ç∏‰∏äÈÉ®„Å´„Éê„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
3. Âêå„ÅòÂïÜÂìÅ„ÅåCosense„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„ÄÅ„Åù„ÅÆ„Éö„Éº„Ç∏„Å∏„ÅÆ„É™„É≥„ÇØ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
4. ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„ÄÅÊñ∞Ë¶è„Éö„Éº„Ç∏‰ΩúÊàêÁî®„ÅÆ„É™„É≥„ÇØ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô

### Cosense„Éö„Éº„Ç∏„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫

Êã°ÂºµÊ©üËÉΩ„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åß„ÄÅCosense„Å´‰øùÂ≠ò„Åô„Çã„Éö„Éº„Ç∏„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíËá™Áî±„Å´Ë®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂ§âÊï∞„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇ

- `{title}`: ÂïÜÂìÅ„ÅÆ„Çø„Ç§„Éà„É´
- `{authors}`: ËëóËÄÖÂêçÔºàË§áÊï∞„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Çπ„Éö„Éº„ÇπÂå∫Âàá„Çä„Åß„É™„É≥„ÇØÂΩ¢ÂºèÔºâ
- `{service}`: „Çµ„Éº„Éì„ÇπÂêçÔºà‰æã: FANZA, AmazonÔºâ
- `{url}`: ÂïÜÂìÅ„Éö„Éº„Ç∏„ÅÆURL
- `{publishedYear}`: Áô∫Ë°åÂπ¥
- `{publishedMonth}`: Áô∫Ë°åÊúà
- `{publishedDate}`: Áô∫Ë°åÊó•

**‰æã:**
```
[{service}„ÅßË™≠„ÇÄ {url}]
[[ËëóËÄÖ]]Ôºö{authors}
[[Ê¶ÇË¶Å]]Ôºö
[[Áô∫Ë°åÂπ¥]]Ôºö{publishedYear}/{publishedMonth}/{publishedDate}
```

## Browser Support

„Åì„ÅÆÊã°ÂºµÊ©üËÉΩ„ÅØ‰ª•‰∏ã„ÅÆ„Éñ„É©„Ç¶„Ç∂„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„ÅôÔºö

- **Google Chrome** (Manifest V3)
- **Mozilla Firefox** (Manifest V3 with Event Pages)

## Building

### Âü∫Êú¨„ÅÆ„Éì„É´„ÉâÊñπÊ≥ï

1.  Clone repo
2.  `npm i`
3.  ÈñãÁô∫Áî®: `npm run dev` „Åæ„Åü„ÅØ `npm run watch`
4.  Êú¨Áï™Áî®: `npm run build`

### „Éñ„É©„Ç¶„Ç∂Âà•„Éì„É´„Éâ

Chrome „Å® Firefox „ÅßÁï∞„Å™„ÇãÂÆüË£Ö„ÅåÂøÖË¶Å„Å™„Åü„ÇÅ„ÄÅ„Éñ„É©„Ç¶„Ç∂Âà•„ÅÆ„Éì„É´„Éâ„Ç≥„Éû„É≥„Éâ„ÇíÁî®ÊÑè„Åó„Å¶„ÅÑ„Åæ„ÅôÔºö

```bash
# ChromeÁî®„Éì„É´„Éâ
npm run build:chrome
npm run dev:chrome
npm run watch:chrome

# FirefoxÁî®„Éì„É´„Éâ  
npm run build:firefox
npm run dev:firefox
npm run watch:firefox
```

### ÈÖçÂ∏ÉÁî®„Éë„ÉÉ„Ç±„Éº„Ç∏„É≥„Ç∞

ÂêÑ„Éñ„É©„Ç¶„Ç∂„Çπ„Éà„Ç¢Âêë„Åë„ÅÆZIP„Éï„Ç°„Ç§„É´„ÇíËá™ÂãïÁîüÊàêÔºö

```bash
# ChromeÁî®ZIP„Éë„ÉÉ„Ç±„Éº„Ç∏‰ΩúÊàê
npm run package:chrome    # ‚Üí uni-chrome.zip

# FirefoxÁî®ZIP„Éë„ÉÉ„Ç±„Éº„Ç∏‰ΩúÊàê  
npm run package:firefox   # ‚Üí uni-firefox.zip

# ‰∏°ÊñπÂêåÊôÇ‰ΩúÊàê
npm run package:all
```

„Éì„É´„ÉâÁµêÊûú„ÅØ‰ª•‰∏ã„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™ÊßãÈÄ†„ÅßÂá∫Âäõ„Åï„Çå„Åæ„ÅôÔºö
```
dist/
‚îú‚îÄ‚îÄ chrome/        # ChromeÁî®„Éì„É´„Éâ
‚îú‚îÄ‚îÄ firefox/       # FirefoxÁî®„Éì„É´„Éâ
‚îî‚îÄ‚îÄ *.png         # „Ç¢„Ç§„Ç≥„É≥„Éï„Ç°„Ç§„É´
```

## Installation

### Google Chrome

1.  `npm run build:chrome` „ÅßChrome„Éì„É´„Éâ„ÇíÂÆüË°å
2.  [chrome://extensions](chrome://extensions) „ÇíÈñã„Åè
3.  „Äå„Éá„Éô„É≠„ÉÉ„Éë„Éº„É¢„Éº„Éâ„Äç„ÇíÊúâÂäπ„Å´„Åô„Çã
4.  „Äå„Éë„ÉÉ„Ç±„Éº„Ç∏Âåñ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÊã°ÂºµÊ©üËÉΩ„ÇíË™≠„ÅøËæº„ÇÄ„Äç„Åß `dist/chrome` „Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû

### Mozilla Firefox

1.  `npm run build:firefox` „ÅßFirefox„Éì„É´„Éâ„ÇíÂÆüË°å
2.  [about:debugging](about:debugging) „ÇíÈñã„Åè
3.  „Äå„Åì„ÅÆ Firefox„Äç‚Üí„Äå‰∏ÄÊôÇÁöÑ„Å™„Ç¢„Éâ„Ç™„É≥„ÇíË™≠„ÅøËæº„ÇÄ„Äç
4.  `dist/firefox` „Éï„Ç©„É´„ÉÄÂÜÖ„ÅÆ `manifest.json` „ÇíÈÅ∏Êäû

### „Çπ„Éà„Ç¢ÈÖçÂ∏ÉÁî®

ÈÖçÂ∏ÉÁî®ZIP„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàêÔºö
```bash
npm run package:chrome   # Chrome Web StoreÁî®
npm run package:firefox  # Firefox Add-onsÁî®
```

## Technical Details

### Browser Differences

„Åì„ÅÆÊã°ÂºµÊ©üËÉΩ„ÅØ `wext-manifest-loader` „Çí‰ΩøÁî®„Åó„Å¶„Éñ„É©„Ç¶„Ç∂Èñì„ÅÆÂ∑ÆÁï∞„ÇíÂê∏Âèé„Åó„Å¶„ÅÑ„Åæ„ÅôÔºö

**Chrome (Manifest V3)**
- `action` „Éï„Ç£„Éº„É´„Éâ„Çí‰ΩøÁî®
- `background.service_worker` „ÅßService WorkerÂÆüË°å

**Firefox (Manifest V3)**  
- `browser_action` „Éï„Ç£„Éº„É´„Éâ„Çí‰ΩøÁî®
- `background.scripts` „ÅßEvent PagesÂÆüË°å

### Cross-browser API Compatibility

`webextension-polyfill` „Çí‰ΩøÁî®„Åó„Å¶„Éñ„É©„Ç¶„Ç∂APIÈñì„ÅÆ‰∫íÊèõÊÄß„ÇíÁ¢∫‰øù„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

## Testing & Debugging

### Test Commands

- `npm run test:small` - Unit tests (Jest)
- `npm run test:medium` - All integration tests (both Japan and Global sites)
- `npm run test:medium:japan` - Japan-restricted tests requiring Japan IP (FANZA, Amazon)
- `npm run test:medium:global` - Global-accessible tests (BookWalker, DLsite, etc.)
- `npm test` - All standard tests (small + medium)

**Note**: Japan-restricted tests may fail in CI due to geographic restrictions but are still executed with `continue-on-error` for monitoring purposes.

### Failed Test Selective Re-execution (Local Development)

For efficient local development, you can selectively re-run only the tests that failed in CI instead of running the entire test suite:

#### Recommended Workflow
```bash
# 1. Extract failed tests from latest CI failure (requires GitHub CLI)
npm run test:extract-failed-from-ci

# 2. Or specify a specific CI run ID
npm run test:extract-failed-from-ci [RUN_ID]

# 3. Run only the failed tests locally
npm run test:failed-only

# 4. Fix issues and commit - CI will run all tests for safety
```

#### Alternative: Manual Log Extraction
```bash
# If you have a CI failure log file saved locally
npm run test:extract-failed ci-log.txt

# Or extract from current local test run (script provides sample patterns)
npm run test:extract-failed

# Then run only failed tests
npm run test:failed-only
```

#### Requirements
- **GitHub CLI**: Install with `gh auth login` for CI log extraction
- **Local Development Only**: CI always runs all tests to ensure no regressions

#### How It Works
- `scripts/extract-from-ci.js` fetches CI failure logs via GitHub CLI
- `scripts/extract-failed-tests.js` parses Playwright output and extracts failed test names
- Failed test patterns are saved to `failed-tests-patterns.txt`
- `npm run test:failed-only` reads these patterns and runs only matching tests
- **CI Safety**: All workflows run complete test suites to maintain reliability

### CI Environment vs Local Environment

„ÉÜ„Çπ„Éà„ÅåÊâãÂÖÉ„Åß„ÅØÊàêÂäü„Åô„Çã„ÅåCIÁí∞Â¢É„ÅßÂ§±Êïó„Åô„ÇãÂ†¥Âêà„ÄÅÂú∞ÁêÜÁöÑIPÂà∂Èôê„Å´„Çà„ÇãÂÜÖÂÆπ„ÅÆÈÅï„ÅÑ„ÅåÂéüÂõ†„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ

#### ‰∏ª„Å™ÈÅï„ÅÑ
- **CIÁí∞Â¢É (GitHub Actions, Wyoming, US)**: Êµ∑Â§ñIP„Å®„Åó„Å¶Êâ±„Çè„Çå„ÄÅËã±Ë™û„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅåË°®Á§∫„Åï„Çå„Çã
- **ÊâãÂÖÉÁí∞Â¢É (Êó•Êú¨)**: Êó•Êú¨Ë™û„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅåË°®Á§∫„Åï„Çå„Çã

#### FANZAÂπ¥ÈΩ¢Ë™çË®º„ÅÆ‰æã
```typescript
// CIÁí∞Â¢É: Ëã±Ë™ûÂπ¥ÈΩ¢Ë™çË®º„Éö„Éº„Ç∏ (/en/age_check/)
// „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà: "I Agree", "Agree", "Yes"

// ÊâãÂÖÉÁí∞Â¢É: Êó•Êú¨Ë™ûÂπ¥ÈΩ¢Ë™çË®º„Éö„Éº„Ç∏
// „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà: "„ÅØ„ÅÑ"
```

### CIÁí∞Â¢É„Åß„ÅÆDOM„Éá„Éê„ÉÉ„Ç∞ÊñπÊ≥ï

#### 1. Â∞ÇÁî®„Éá„Éê„ÉÉ„Ç∞„ÉÜ„Çπ„Éà„ÅÆ‰ΩúÊàê
```bash
# Â§±Êïó„Åó„Å¶„ÅÑ„Çã„Çµ„Ç§„Éà„ÅÆ„Åø„ÅÆË©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞„ÉÜ„Çπ„Éà„Çí‰ΩúÊàê
npm run test:quick  # FANZA Video, FANZA Doujin, Amazon English„ÅÆ„ÅøÂÆüË°å
```

#### 2. CIË®≠ÂÆö„ÅÆ‰∏ÄÊôÇÂ§âÊõ¥
`playwright.config.ts` „ÅßCIÁí∞Â¢ÉÁî®„ÅÆË®≠ÂÆö„ÇíË™øÊï¥Ôºö
```typescript
// „Éá„Éê„ÉÉ„Ç∞„ÉÜ„Çπ„Éà„ÅÆ„ÅøÂÆüË°å
testMatch: process.env.CI ? '**/__tests__/medium/monitoring/fanza-debug.test.ts' : '**/__tests__/medium/**/*.test.ts'
```

#### 3. GitHub Actions„É≠„Ç∞„ÅÆÁ¢∫Ë™ç
```bash
# ÊúÄÊñ∞„ÅÆ„ÉÜ„Çπ„ÉàÁµêÊûú„ÇíÁ¢∫Ë™ç
gh run list --limit 5

# ÁâπÂÆö„ÅÆ„ÉÜ„Çπ„ÉàÂÆüË°å„ÅÆ„É≠„Ç∞„ÇíÁ¢∫Ë™ç
gh run view [RUN_ID] --log | grep -A 50 "üîç Debugging"

# DOMÂàÜÊûêÁµêÊûú„ÇíÁ¢∫Ë™ç
gh run view [RUN_ID] --log | grep -A 10 "BUTTON ELEMENTS FOUND"
```

#### 4. DOMÊßãÈÄ†ÂàÜÊûê„ÅÆ„Éù„Ç§„É≥„Éà
- ÂÆüÈöõ„ÅÆHTMLÊßãÈÄ†„ÅÆÁ¢∫Ë™çÔºàÊÉ≥ÂÉè„Åß„ÅØ„Å™„ÅèÂÆüÈöõ„ÅÆDOMÔºâ
- „Éú„Çø„É≥Ë¶ÅÁ¥†„ÅÆË©≥Á¥∞ÊÉÖÂ†±ÂèñÂæóÔºàtagName, textContent, className, idÔºâ
- „Çª„É¨„ÇØ„Çø„ÉºË©¶Ë°å„ÅÆÊàêÂäü/Â§±Êïó„É≠„Ç∞
- Generic„Å™fallback„Éë„Çø„Éº„É≥„ÅÆÂõûÈÅøÔºà„Éá„Éê„ÉÉ„Ç∞„ÅåÂõ∞Èõ£„Å´„Å™„Çã„Åü„ÇÅÔºâ

#### 5. „Éá„Éê„ÉÉ„Ç∞„ÉÜ„Çπ„Éà„ÅÆÂÆüË£Ö‰æã
```typescript
// DOMÊßãÈÄ†„ÅÆË©≥Á¥∞ÂàÜÊûê
const buttons = await page.evaluate(() => {
  const buttonElements = Array.from(document.querySelectorAll('button, a[role="button"], input[type="submit"]'));
  return buttonElements.map(btn => ({
    tagName: btn.tagName,
    textContent: btn.textContent?.trim() || '',
    className: btn.className,
    id: btn.id
  }));
});

console.log(`üîò BUTTON ELEMENTS FOUND (${buttons.length}):`);
buttons.forEach((btn, idx) => {
  console.log(`   [${idx}] ${btn.tagName}: "${btn.textContent}" (class: "${btn.className}", id: "${btn.id}")`);
});
```

## Geographic IP Restrictions & CI Environment Behavior

### FANZA Sites Specific Behavior

CIÁí∞Â¢ÉÔºàGitHub Actions, Wyoming, USÔºâ„Åß„ÅÆFANZA„Çµ„Ç§„Éà„Ç¢„ÇØ„Çª„Çπ„Å´„ÅØÂú∞ÁêÜÁöÑÂà∂Èôê„ÅåÈÅ©Áî®„Åï„Çå„Åæ„Åô„ÄÇ

#### Access Pattern Analysis

##### 1. Age Verification Stage
- **Local Environment (Japan IP)**: Japanese age verification page with "„ÅØ„ÅÑ" button
- **CI Environment (US IP)**: English age verification page (`/en/age_check/`) with "I Agree", "Agree" buttons

##### 2. Post-Age Verification Behavior

**Pattern A: Login Redirect (80-90% of cases in CI)**
```
Age Verification Success ‚Üí https://accounts.dmm.co.jp/service/login/password/=
```
- **Cause**: Overseas IP requires additional login authentication
- **Limitation**: Product scraping not possible on login page
- **Current Status**: Incorrectly treated as "age verification failure"

**Pattern B: Direct Content Access (10-20% of cases in CI)**
```
Age Verification Success ‚Üí https://video.dmm.co.jp/av/content/?id=xxxxx
```
- **Result**: Normal scraping possible
- **Status**: Works correctly with current implementation

#### Geographic Restrictions Impact

| Environment | IP Location | Age Verification | Additional Auth | Scraping Capability |
|-------------|-------------|------------------|-----------------|-------------------|
| Local | Japan | Japanese („ÅØ„ÅÑ) | Not required | ‚úÖ Full access |
| CI | Wyoming, US | English (Agree) | Login required | ‚ö†Ô∏è Limited access |

#### Test Success Criteria Considerations

**Current Issue**: The `handleAgeVerification` function treats login pages as failures:
```typescript
if (finalUrl.includes('login')) {
  throw new Error(`Age verification failed - still on auth page: ${finalUrl}`);
}
```

**Recommended Approach**:
1. **Treat login page as partial success** - Age verification was bypassed successfully
2. **Adjust expectations for CI environment** - Geographic restrictions are normal behavior
3. **Document limitations** - Overseas IP access has inherent restrictions

#### Debugging Geographic Issues

When tests fail in CI but pass locally, check for:
1. **Language differences** in age verification pages
2. **Additional authentication requirements** for overseas IPs
3. **Different redirect behavior** based on geographic location
4. **Content availability restrictions** by region

Use the debug workflow (`.github/workflows/debug-ci-environment.yml`) to analyze:
- Actual DOM structure in CI environment
- Geographic-specific page variations
- Authentication flow differences

## VPN Integration for Japan IP Testing

### Overview

To address geographic IP restrictions in CI environments, a VPN integration has been implemented using Gluetun and ProtonVPN Free tier.

**VPN Usage Scope**: VPN is specifically used for FANZA-related tests only, as these sites display different content (Japanese vs English) based on geographic location. Other sites (Amazon, DLsite, BookWalker, etc.) provide consistent content regardless of IP location and therefore do not require VPN.

### Setup Instructions

#### 1. ProtonVPN Account Setup
1. Create a free account at [ProtonVPN](https://protonvpn.com/)
2. Navigate to Account ‚Üí [WireGuard configuration](https://account.proton.me/u/0/vpn/WireGuard)
3. Generate a WireGuard configuration file
4. Copy the `PrivateKey` value from the configuration

#### 2. GitHub Secrets Configuration
Add the following secret to your GitHub repository:

```
PROTONVPN_WIREGUARD_PRIVATE_KEY: [Your WireGuard PrivateKey in base64 format]
```

#### 3. Running VPN Tests

**Manual Trigger:**
```bash
# Via GitHub Actions tab
Actions ‚Üí "testing-with-vpn" ‚Üí "Run workflow"
```

**Branch-based Trigger:**
```bash
# Create/push to vpn-integration branch
git checkout -b vpn-integration
git push origin vpn-integration
```

#### 4. Test Coverage
The VPN workflow specifically targets:
- **Japan-restricted tests** (`npm run test:medium:japan`):
  - FANZA Video: `video.dmm.co.jp`
  - FANZA Doujin: `dmm.co.jp/dc/doujin`
  - FANZA Books: `book.dmm.co.jp`
  - FANZA Anime: `video.dmm.co.jp/anime`
  - Amazon JP: `amazon.co.jp`
- IP verification and country detection
- Proxy connectivity validation

**Note**: Global tests (`npm run test:medium:global`) for DLsite, BookWalker, Melonbooks, etc. run in the standard CI environment without VPN, as they provide consistent content regardless of geographic location.

### Technical Implementation

#### VPN Service Configuration
```yaml
services:
  vpn:
    image: qmcgaw/gluetun
    env:
      VPN_SERVICE_PROVIDER: protonvpn
      VPN_TYPE: wireguard
      WIREGUARD_PRIVATE_KEY: ${{ secrets.PROTONVPN_WIREGUARD_PRIVATE_KEY }}
      SERVER_COUNTRIES: Japan
      FREE_ONLY: "on"
      HTTPPROXY: "on"
```

#### Playwright Proxy Configuration
Tests automatically route through the VPN using HTTP proxy:
```bash
export HTTP_PROXY=http://vpn:8888
export HTTPS_PROXY=http://vpn:8888
```

### Benefits
- **High Performance**: WireGuard protocol for faster speeds
- **Geographic Accuracy**: Tests run with Japan IP addresses
- **FANZA Compatibility**: Access Japanese age verification pages
- **Content Consistency**: Ensures Japanese content only (no English fallbacks)
- **Test Reliability**: Eliminates geographic content variations for FANZA sites
- **Cost Effective**: Uses ProtonVPN's free tier
- **CI Integration**: Automated testing without manual intervention

### Limitations
- **ProtonVPN Free**: Limited to 1 concurrent connection
- **Speed Impact**: Potential latency increase due to VPN routing
- **Dependency**: Requires external service availability
